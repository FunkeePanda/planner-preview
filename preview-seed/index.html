<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Planner App</title>
    <style>
      :root { 
        --bg1:#6c63ff; --bg2:#7a3cf0; 
        --glass: rgba(255,255,255,0.08); 
        --glass-strong: rgba(255,255,255,0.12);
        --border-light: rgba(255,255,255,.12);
        --border-medium: rgba(255,255,255,.25);
        --text-primary: #fff;
        --text-muted: rgba(255,255,255,.8);
        --shadow-card: 0 6px 28px rgba(0,0,0,.25);
        --shadow-fab: 0 10px 28px rgba(0,0,0,.35);
        --radius-sm: 10px;
        --radius-md: 16px;
        --radius-pill: 999px;
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;color:var(--text-primary)}
      header{position:sticky;top:0;backdrop-filter:saturate(140%) blur(8px);background:linear-gradient(160deg,rgba(255,255,255,.08),rgba(255,255,255,.04));border-bottom:1px solid var(--border-light)}
      .bar{height:60px;max-width:960px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:0 16px}
      .title{font-weight:700;letter-spacing:.2px}
      main{max-width:720px;margin:16px auto;padding:16px;padding-bottom:calc(120px + env(safe-area-inset-bottom))}
      .card{background:var(--glass);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:16px 18px;box-shadow:var(--shadow-card)}
      .muted{opacity:.8}

      .btn{
        height:44px; min-height:44px; padding:0 20px; min-width:80px;
        border-radius:var(--radius-pill); border:1px solid var(--border-medium);
        background:linear-gradient(160deg,rgba(255,255,255,.18),rgba(255,255,255,.10));
        backdrop-filter:saturate(140%) blur(8px);
        color:var(--text-primary); font-weight:600; font-size:14px;
        display:inline-flex; align-items:center; justify-content:center;
        cursor:pointer; transition:transform .1s ease;
      }
      .btn:active{ transform: translateY(1px); }
      .btn:hover{ background:linear-gradient(160deg,rgba(255,255,255,.22),rgba(255,255,255,.14)); }
      .btn:focus-visible{ outline:2px solid rgba(255,255,255,.9); outline-offset:2px; border-radius:3px; }

      .fab{
        position:fixed;
        right:max(16px, env(safe-area-inset-right) + 12px);
        bottom:max(16px, env(safe-area-inset-bottom) + 12px);
        height:54px; min-height:44px; min-width:54px; padding:0 16px;
        border-radius:var(--radius-pill); border:1px solid var(--border-medium);
        background:linear-gradient(160deg,rgba(255,255,255,.18),rgba(255,255,255,.10));
        backdrop-filter:saturate(140%) blur(8px);
        color:var(--text-primary); font-weight:600;
        box-shadow:var(--shadow-fab);
        z-index:9999;
      }
      .fab:active{ transform: translateY(1px); }
      .fab:focus-visible{ outline:2px solid rgba(255,255,255,.9); outline-offset:2px; border-radius:3px; }

      .modal-backdrop{
        position:fixed; top:0; left:0; right:0; bottom:0;
        background:rgba(0,0,0,.6); backdrop-filter:blur(4px);
        display:flex; align-items:center; justify-content:center;
        z-index:10000;
      }
      .modal-backdrop[hidden] { display: none !important; pointer-events: none !important; }
      .modal{
        background:var(--glass-strong); border:1px solid var(--border-light);
        border-radius:var(--radius-md); padding:24px; min-width:320px; max-width:90vw;
        box-shadow:0 20px 60px rgba(0,0,0,.4);
      }
      .modal h3{ margin:0 0 16px 0; font-size:18px; }
      .modal input, .modal textarea{
        width:100%; padding:12px; margin-bottom:12px;
        border:1px solid var(--border-light); border-radius:var(--radius-sm);
        background:rgba(255,255,255,.08); color:var(--text-primary);
        font:inherit;
      }
      .modal input::placeholder, .modal textarea::placeholder{ color:var(--text-muted); }
      .modal-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:20px; }

      .tab-bar{
        position:fixed; bottom:0; 
        left:max(0px, env(safe-area-inset-left)); 
        right:max(0px, env(safe-area-inset-right));
        padding:max(8px, env(safe-area-inset-bottom) + 8px) 16px 8px;
        background:linear-gradient(160deg,rgba(255,255,255,.12),rgba(255,255,255,.08));
        backdrop-filter:saturate(140%) blur(8px);
        border-top:1px solid var(--border-light);
        display:flex; gap:4px; justify-content:center;
        z-index:9998;
      }
      .tab-btn{
        flex:1; max-width:120px; height:48px; min-height:44px; min-width:44px; padding:8px;
        border:none; background:transparent; color:var(--text-muted);
        border-radius:var(--radius-sm); font-size:12px; font-weight:500;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        cursor:pointer; transition:all .2s ease;
      }
      .tab-btn[aria-selected="true"]{
        color:var(--text-primary);
        background:rgba(255,255,255,.1);
      }
      .tab-btn:active{ transform:scale(.95); }
      .tab-btn:focus-visible{ outline:2px solid rgba(255,255,255,.9); outline-offset:2px; border-radius:3px; }

      .day-grid{
        display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:12px;
      }
      .day-box{
        aspect-ratio:1; background:rgba(255,255,255,.06);
        border:1px solid var(--border-light); border-radius:8px;
        display:flex; align-items:center; justify-content:center;
        font-size:12px; font-weight:600;
      }
      .settings-row{
        display:flex; justify-content:space-between; align-items:center;
        padding:12px 0; border-bottom:1px solid rgba(255,255,255,.08);
      }
      .settings-row:last-child{ border-bottom:none; }

      .shake{
        animation: shake 0.3s ease-in-out;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }

      .toast{
        position:fixed; left:50%; bottom:calc(80px + env(safe-area-inset-bottom));
        transform:translateX(-50%); padding:12px 20px;
        background:rgba(0,0,0,.8); color:var(--text-primary);
        border-radius:var(--radius-pill); font-size:14px; font-weight:500;
        z-index:10001; opacity:0; transition:opacity .3s ease;
      }
      .toast.show{ opacity:1; }

      input[type="checkbox"][data-role="toggle-done"] {
        width: 28px; height: 28px; min-width: 28px; min-height: 28px;
      }
      
      .task--done{
        opacity:0.4;
      }
      .task--done .task-title{
        text-decoration:line-through;
        opacity:.65;
      }
      .task--done .btn-start{
        display:none;
      }

      .row{
        display:flex;
        align-items:center;
      }
      .between{
        justify-content:space-between;
      }
      .small{
        font-size:13px;
      }
      .link-btn{
        background:none;
        border:none;
        color:var(--text-primary);
        text-decoration:underline;
        cursor:pointer;
        font:inherit;
        padding:0;
      }
      .link-btn:hover{
        opacity:.8;
      }

      .sr-only{
        position:absolute;
        width:1px;
        height:1px;
        padding:0;
        margin:-1px;
        overflow:hidden;
        clip:rect(0,0,0,0);
        white-space:nowrap;
        border:0;
      }
    </style>
  </head>
  <body>
    <header><div class="bar"><div class="title">Planner App</div></div></header>

    <main>
      <section id="tab-today">
        <div class="card">
          <h2 style="margin:0 0 10px 0">Today — step 1.3c</h2>
          <div class="muted" style="margin-bottom:14px">State-driven tasks with proper completion flow.</div>

          <div id="today-list" style="list-style:none;padding:0;margin:0;display:grid;gap:10px">
            <!-- Tasks will be rendered here by JavaScript -->
          </div>

                      <section id="today-completed" aria-label="Completed tasks" style="margin-top:20px">
              <header class="row between small muted" style="margin-bottom:12px">
                <div>Completed (<span id="completed-count">0</span>)</div>
                <button id="clear-completed" class="link-btn" aria-label="Reset all tasks to incomplete">Clear</button>
              </header>
              <div id="completed-list" style="display:grid;gap:10px"></div>
            </section>

            <!-- Debug footer -->
            <footer id="debug-footer" style="opacity:.6;font-size:12px;padding:8px 16px;margin-top:16px">
              build: STEP-1.3c — active:0 done:0
            </footer>
        </div>
      </section>

      <section id="tab-week" hidden>
        <div class="card">
          <h2 style="margin:0 0 10px 0">Week (placeholder)</h2>
          <div class="muted" style="margin-bottom:14px">Weekly view coming soon.</div>
          <div class="day-grid">
            <div class="day-box">M</div>
            <div class="day-box">T</div>
            <div class="day-box">W</div>
            <div class="day-box">T</div>
            <div class="day-box">F</div>
            <div class="day-box">S</div>
            <div class="day-box">S</div>
          </div>
        </div>
      </section>

      <section id="tab-settings" hidden>
        <div class="card">
          <h2 style="margin:0 0 16px 0">Settings (placeholder)</h2>
          <div class="settings-row">
            <span>Theme</span>
            <span class="muted">System</span>
          </div>
          <div class="settings-row">
            <span>Conflicts</span>
            <span class="muted">On</span>
          </div>
        </div>
      </section>
    </main>

    <div id="modal-backdrop" class="modal-backdrop" hidden>
      <div class="modal">
        <h3>New Task</h3>
        <form id="task-form">
          <input id="task-title" type="text" placeholder="Task name" required />
          <select id="task-duration">
            <option value="">None</option>
            <option value="5">5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="25">25 minutes</option>
            <option value="45">45 minutes</option>
          </select>
          <input id="task-tag" type="text" placeholder="Tag or area (optional)" />
        </form>
        <div class="modal-actions">
          <button id="modal-cancel" class="btn">Cancel</button>
          <button id="modal-save" class="btn">Save</button>
        </div>
      </div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn" data-tab="today" aria-selected="true">Today</button>
      <button class="tab-btn" data-tab="week" aria-selected="false">Week</button>
      <button class="tab-btn" data-tab="settings" aria-selected="false">Settings</button>
    </div>

    <button class="fab" aria-label="Add task">+ Add task</button>

    <!-- Accessibility announcements -->
    <div id="task-announcements" class="sr-only" aria-live="polite"></div>

    <!-- build-stamp: to verify deploy -->
    <div style="position:fixed;left:8px;bottom:8px;font-size:11px;opacity:.55">
      build: STEP-1.3c
    </div>

    <script>
      // Storage helper
      const STORAGE_KEY = "planner:today:v1";
      
      function generateId() {
        return Date.now().toString() + Math.random().toString(36).substr(2, 5);
      }

      function getTodayTasks() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          const tasks = stored ? JSON.parse(stored) : [];
          
          // Coerce completed to boolean (safeguard for corrupted data)
          return tasks.map(task => ({
            ...task,
            completed: Boolean(task.completed)
          }));
        } catch (e) {
          console.warn('Failed to parse stored tasks:', e);
          return [];
        }
      }

      function setTodayTasks(tasks) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        } catch (e) {
          console.warn('Failed to store tasks:', e);
        }
      }

      // Placeholder for future native haptics
      function tryHaptic(type) {
        console.log(`Haptic feedback: ${type}`);
      }

      // Simple tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          
          // Haptic feedback
          tryHaptic('tab');
          
          // Hide all sections
          document.querySelectorAll('section[id^="tab-"]').forEach(section => {
            section.hidden = true;
          });
          
          // Show target section
          document.getElementById(`tab-${targetTab}`).hidden = false;
          
          // Update tab button states
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.setAttribute('aria-selected', 'false');
          });
          btn.setAttribute('aria-selected', 'true');
        });
      });

      // Toast helper
      function createToast(text) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = text;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 1500);
      }

      // Task creation helper
      function createTaskCard(task) {
        const card = document.createElement('div');
        card.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)';
        card.dataset.taskId = task.id;
        
        const tagLine = task.tag ? `<div class="muted" style="font-size:13px">${task.tag}</div>` : '';
        const durationPill = task.minutes ? `<span style="font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08)">${task.minutes}m</span>` : '';
        
        card.innerHTML = `
          <input type="checkbox" data-role="toggle-done" 
                 aria-label="Mark ${task.title} ${task.completed ? 'incomplete' : 'complete'}"
                 ${task.completed ? 'checked' : ''}>
          <div style="flex:1">
            <div class="task-title" style="font-weight:600">${task.title}</div>
            ${tagLine}
          </div>
          ${durationPill}
          <button class="btn-start" style="margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff">Start</button>
        `;
        
        if (task.completed) {
          card.classList.add('task--done');
        }
        
        return card;
      }

      // Get task data from DOM card
      function getTaskFromCard(card) {
        const checkbox = card.querySelector('input[data-role="toggle-done"]');
        const titleEl = card.querySelector('.task-title');
        const tagEl = card.querySelector('.muted');
        const durationEl = card.querySelector('span[style*="border-radius:999px"]');
        
        return {
          id: card.dataset.taskId,
          title: titleEl ? titleEl.textContent : '',
          tag: tagEl ? tagEl.textContent : '',
          minutes: durationEl ? parseInt(durationEl.textContent) : undefined,
          completed: checkbox ? checkbox.checked : false,
          createdAt: new Date().toISOString()
        };
      }

      // Modal management
      (function () {
        const backdrop = document.getElementById('modal-backdrop');
        const cancelBtn = document.getElementById('modal-cancel');
        const saveBtn = document.getElementById('modal-save');
        const fab = document.querySelector('.fab');
        const form = document.getElementById('task-form');
        const titleInput = document.getElementById('task-title');
        const durationSelect = document.getElementById('task-duration');
        const tagInput = document.getElementById('task-tag');
        const todayList = document.getElementById('today-list');

        function hideModal() { 
          backdrop.setAttribute('hidden',''); 
          form.reset();
          titleInput.classList.remove('shake');
        }
        
        function showModal() { 
          backdrop.removeAttribute('hidden'); 
          titleInput.focus();
        }

        // Ensure hidden on load
        hideModal();

        // FAB opens modal
        fab?.addEventListener('click', showModal);

        // Close on Cancel, clicking the dim area, or Esc
        cancelBtn?.addEventListener('click', hideModal);
        backdrop?.addEventListener('click', (e) => {
          if (e.target === backdrop) hideModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') hideModal();
        });

        // Save task
        saveBtn?.addEventListener('click', () => {
          const title = titleInput.value.trim();
          const duration = durationSelect.value;
          const tag = tagInput.value.trim();

          if (!title) {
            titleInput.classList.add('shake');
            titleInput.focus();
            setTimeout(() => titleInput.classList.remove('shake'), 300);
            return;
          }

          // Create task object
          const task = {
            id: generateId(),
            title: title,
            tag: tag || undefined,
            minutes: duration ? parseInt(duration) : undefined,
            completed: false,
            createdAt: new Date().toISOString()
          };

          // Add task using the state management system
          addTask(task);

          // Close modal and show toast
          hideModal();
          createToast('Task added');
        });

        // Expose for future use (optional)
        window.__modal = { show: showModal, hide: hideModal };
      })();

      // Task state management and persistence
      (function () {
        const todayList = document.getElementById('today-list');
        const completedList = document.getElementById('completed-list');
        const completedCount = document.getElementById('completed-count');
        const clearBtn = document.getElementById('clear-completed');
        const announcements = document.getElementById('task-announcements');

        // In-memory task state
        let tasks = [];

        function announce(text) {
          announcements.textContent = text;
        }

        function updateCompletedCount() {
          const doneCount = tasks.filter(t => t.completed).length;
          completedCount.textContent = doneCount;
        }

        function saveTasksToStorage() {
          setTodayTasks(tasks);
        }

        function toggleComplete(taskId) {
          // Update state immutably
          tasks = tasks.map(task => 
            task.id === taskId 
              ? { ...task, completed: !task.completed }
              : task
          );
          
          // Re-render and persist
          renderTasks();
          saveTasksToStorage();
          
          // Announce change
          const task = tasks.find(t => t.id === taskId);
          if (task) {
            announce(task.completed ? 'Task completed' : 'Task active');
          }
        }

        function clearCompleted() {
          // Reset all tasks to incomplete (like the Clear button spec)
          tasks = tasks.map(task => ({ ...task, completed: false }));
          
          // Re-render and persist
          renderTasks();
          saveTasksToStorage();
        }

        function addTask(taskData) {
          // Add to state
          tasks = [taskData, ...tasks];
          
          // Re-render and persist
          renderTasks();
          saveTasksToStorage();
        }

        function renderTasks() {
          // Derive lists from state (like useMemo)
          const active = tasks.filter(t => !t.completed);
          const done = tasks.filter(t => t.completed);

          // Clear existing DOM
          todayList.innerHTML = '';
          completedList.innerHTML = '';

          // Render active tasks
          active.forEach(task => {
            const card = createTaskCard(task);
            todayList.appendChild(card);
          });

          // Render completed tasks  
          done.forEach(task => {
            const card = createTaskCard(task);
            completedList.appendChild(card);
          });

          updateCompletedCount();
          updateDebugFooter(active.length, done.length);
        }

        function updateDebugFooter(activeCount, doneCount) {
          const debugFooter = document.getElementById('debug-footer');
          if (debugFooter) {
            debugFooter.textContent = `build: STEP-1.3c — active:${activeCount} done:${doneCount}`;
          }
        }

        // Controlled checkbox event delegation
        function handleCheckboxChange(e) {
          const checkbox = e.target;
          if (checkbox.type === 'checkbox' && checkbox.dataset.role === 'toggle-done') {
            const card = checkbox.closest('div[style*="display:flex"]');
            const taskId = card?.dataset.taskId;
            
            if (taskId) {
              // Prevent default and control the checkbox state
              e.preventDefault();
              toggleComplete(taskId);
            }
          }
        }

        // Event listeners
        todayList?.addEventListener('click', handleCheckboxChange);
        completedList?.addEventListener('click', handleCheckboxChange);

        clearBtn?.addEventListener('click', clearCompleted);

        // Load tasks from storage on init
        function loadTasksFromStorage() {
          const storedTasks = getTodayTasks();
          
          if (storedTasks.length === 0) {
            // Create seed data if no stored tasks
            tasks = [
              {
                id: generateId(),
                title: 'Deep Work: "Main project"',
                tag: '2/4 subtasks • focus',
                minutes: 25,
                completed: false,
                createdAt: new Date().toISOString()
              },
              {
                id: generateId(),
                title: 'Reply to messages',
                tag: 'No subtasks',
                minutes: undefined,
                completed: false,
                createdAt: new Date().toISOString()
              },
              {
                id: generateId(),
                title: 'Walk outside',
                tag: 'Wellbeing',
                minutes: 15,
                completed: false,
                createdAt: new Date().toISOString()
              }
            ];
            saveTasksToStorage();
          } else {
            tasks = storedTasks;
          }

          renderTasks();
        }

        // Expose functions globally
        window.toggleComplete = toggleComplete;
        window.addTask = addTask;
        window.saveTasksToStorage = saveTasksToStorage;

        // Initialize
        loadTasksFromStorage();
      })();
    </script>
  </body>
</html>